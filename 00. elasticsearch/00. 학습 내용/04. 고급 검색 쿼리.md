# 04. 고급 검색 쿼리

---

# 샘플 데이터 생성

고급 검색 쿼리를 학습하기에 앞서 적절한 데이터를 입력해야 한다.

## 1) 인덱스 매핑

```json
PUT /movies
{
  "settings": {
    "analysis": {
      "analyzer": {
        "kr_text": {
          "type": "custom",
          "tokenizer": "nori_tokenizer",
          "filter": ["lowercase"]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "title":        { "type": "text", "analyzer": "kr_text" },
      "overview":     { "type": "text", "analyzer": "kr_text" },
      "genres":       { "type": "keyword" },
      "year":         { "type": "integer" },
      "rating":       { "type": "float" },
      "vote_count":   { "type": "integer" },
      "popularity":   { "type": "float" },
      "actors":       { "type": "keyword" },
      "directors":    { "type": "keyword" }
    }
  }
}
{
  "acknowledged": true,
  "shards_acknowledged": true,
  "index": "movies"
}
```

## 2) 데이터 색인 (Bulk API)

```json
POST /_bulk
{ "index": { "_index": "movies", "_id": 1 } }
{ "title": "어벤져스: 엔드게임", "overview": "사라진 모두를 되찾기 위한 마지막 전쟁.", "genres": ["Action","Adventure","Sci-Fi"], "year": 2019, "rating": 8.4, "vote_count": 2500000, "popularity": 98.7, "actors": ["로버트 다우니 주니어","크리스 에반스"], "directors": ["안소니 루소","조 루소"] }
{ "index": { "_index": "movies", "_id": 2 } }
{ "title": "인셉션", "overview": "꿈을 훔치는 도둑의 마지막 미션.", "genres": ["Action","Sci-Fi","Thriller"], "year": 2010, "rating": 8.8, "vote_count": 2300000, "popularity": 92.1, "actors": ["레오나르도 디카프리오","조셉 고든 레빗"], "directors": ["크리스토퍼 놀란"] }
{ "index": { "_index": "movies", "_id": 3 } }
{ "title": "기생충", "overview": "두 가족의 만남과 비극적인 결말.", "genres": ["Drama","Thriller"], "year": 2019, "rating": 8.6, "vote_count": 800000, "popularity": 90.5, "actors": ["송강호","이선균"], "directors": ["봉준호"] }
{ "index": { "_index": "movies", "_id": 4 } }
{ "title": "인터스텔라", "overview": "인류의 생존을 건 우주 탐사.", "genres": ["Adventure","Drama","Sci-Fi"], "year": 2014, "rating": 8.7, "vote_count": 1900000, "popularity": 95.2, "actors": ["매튜 매커너히","앤 해서웨이"], "directors": ["크리스토퍼 놀란"] }
{ "index": { "_index": "movies", "_id": 5 } }
{ "title": "스파이더맨: 노 웨이 홈", "overview": "정체가 밝혀진 스파이더맨의 차원 여행.", "genres": ["Action","Adventure"], "year": 2021, "rating": 8.3, "vote_count": 1700000, "popularity": 97.8, "actors": ["톰 홀랜드","젠데이아"], "directors": ["존 왓츠"] }
{
  "errors": false,
  "took": 6610999,
  "items": [
    {
      "index": {
        "_index": "movies",
        "_id": "1",
        "_version": 1,
        "result": "created",
        "_shards": {
          "total": 2,
          "successful": 2,
          "failed": 0
        },
        "_seq_no": 0,
        "_primary_term": 1,
        "status": 201
      }
    },
    {
      "index": {
        "_index": "movies",
        "_id": "2",
        "_version": 1,
        "result": "created",
        "_shards": {
          "total": 2,
          "successful": 2,
          "failed": 0
        },
        "_seq_no": 1,
        "_primary_term": 1,
        "status": 201
      }
    },
    {
      "index": {
        "_index": "movies",
        "_id": "3",
        "_version": 1,
        "result": "created",
        "_shards": {
          "total": 2,
          "successful": 2,
          "failed": 0
        },
        "_seq_no": 2,
        "_primary_term": 1,
        "status": 201
      }
    },
    {
      "index": {
        "_index": "movies",
        "_id": "4",
        "_version": 1,
        "result": "created",
        "_shards": {
          "total": 2,
          "successful": 2,
          "failed": 0
        },
        "_seq_no": 3,
        "_primary_term": 1,
        "status": 201
      }
    },
    {
      "index": {
        "_index": "movies",
        "_id": "5",
        "_version": 1,
        "result": "created",
        "_shards": {
          "total": 2,
          "successful": 2,
          "failed": 0
        },
        "_seq_no": 4,
        "_primary_term": 1,
        "status": 201
      }
    }
  ]
}
```

## 3) 색인 확인

```json
GET /movies/_search?size=3
{
  "took": 2,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 5,
      "relation": "eq"
    },
    "max_score": 1,
    "hits": [
      {
        "_index": "movies",
        "_id": "1",
        "_score": 1,
        "_source": {
          "title": "어벤져스: 엔드게임",
          "overview": "사라진 모두를 되찾기 위한 마지막 전쟁.",
          "genres": [
            "Action",
            "Adventure",
            "Sci-Fi"
          ],
          "year": 2019,
          "rating": 8.4,
          "vote_count": 2500000,
          "popularity": 98.7,
          "actors": [
            "로버트 다우니 주니어",
            "크리스 에반스"
          ],
          "directors": [
            "안소니 루소",
            "조 루소"
          ]
        }
      },
      {
        "_index": "movies",
        "_id": "2",
        "_score": 1,
        "_source": {
          "title": "인셉션",
          "overview": "꿈을 훔치는 도둑의 마지막 미션.",
          "genres": [
            "Action",
            "Sci-Fi",
            "Thriller"
          ],
          "year": 2010,
          "rating": 8.8,
          "vote_count": 2300000,
          "popularity": 92.1,
          "actors": [
            "레오나르도 디카프리오",
            "조셉 고든 레빗"
          ],
          "directors": [
            "크리스토퍼 놀란"
          ]
        }
      },
      {
        "_index": "movies",
        "_id": "3",
        "_score": 1,
        "_source": {
          "title": "기생충",
          "overview": "두 가족의 만남과 비극적인 결말.",
          "genres": [
            "Drama",
            "Thriller"
          ],
          "year": 2019,
          "rating": 8.6,
          "vote_count": 800000,
          "popularity": 90.5,
          "actors": [
            "송강호",
            "이선균"
          ],
          "directors": [
            "봉준호"
          ]
        }
      }
    ]
  }
}
```

------



# 🧠 A. Bool Query 실습

```json
GET /movies/_search
{
  "query": {
    "bool": {
      "must": [
        { "match": { "overview": "전쟁" } }
      ],
      "filter": [
        { "term": { "genres": "Action" } },
        { "range": { "rating": { "gte": 8.0 } } }
      ]
    }
  }
}
```

→ “전쟁”이라는 단어가 줄거리에 등장하고, 액션 장르이며 평점 8.0 이상인 영화 검색.

```json
{
  "took": 16,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 1,
      "relation": "eq"
    },
    "max_score": 1.3386735,
    "hits": [
      {
        "_index": "movies",
        "_id": "1",
        "_score": 1.3386735,
        "_source": {
          "title": "어벤져스: 엔드게임",
          "overview": "사라진 모두를 되찾기 위한 마지막 전쟁.",
          "genres": [
            "Action",
            "Adventure",
            "Sci-Fi"
          ],
          "year": 2019,
          "rating": 8.4,
          "vote_count": 2500000,
          "popularity": 98.7,
          "actors": [
            "로버트 다우니 주니어",
            "크리스 에반스"
          ],
          "directors": [
            "안소니 루소",
            "조 루소"
          ]
        }
      }
    ]
  }
}
```

# 🔍 B. Full-text Query 실습

```json
GET /movies/_search
{
  "query": {
    "multi_match": {
      "query": "꿈의 세계",
      "fields": ["title^3", "overview"]
    }
  }
}
```

→ 영화 제목(`title`)과 줄거리(`overview`)에서 “꿈의 세계” 관련된 영화 찾기.

→ `title`에 3배 가중치 부여.

```json
{
  "took": 10,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 4,
      "relation": "eq"
    },
    "max_score": 1.768334,
    "hits": [
      {
        "_index": "movies",
        "_id": "2",
        "_score": 1.768334,
        "_source": {
          "title": "인셉션",
          "overview": "꿈을 훔치는 도둑의 마지막 미션.",
          "genres": [
            "Action",
            "Sci-Fi",
            "Thriller"
          ],
          "year": 2010,
          "rating": 8.8,
          "vote_count": 2300000,
          "popularity": 92.1,
          "actors": [
            "레오나르도 디카프리오",
            "조셉 고든 레빗"
          ],
          "directors": [
            "크리스토퍼 놀란"
          ]
        }
      },
      {
        "_index": "movies",
        "_id": "4",
        "_score": 0.30389795,
        "_source": {
          "title": "인터스텔라",
          "overview": "인류의 생존을 건 우주 탐사.",
          "genres": [
            "Adventure",
            "Drama",
            "Sci-Fi"
          ],
          "year": 2014,
          "rating": 8.7,
          "vote_count": 1900000,
          "popularity": 95.2,
          "actors": [
            "매튜 매커너히",
            "앤 해서웨이"
          ],
          "directors": [
            "크리스토퍼 놀란"
          ]
        }
      },
      {
        "_index": "movies",
        "_id": "3",
        "_score": 0.27779987,
        "_source": {
          "title": "기생충",
          "overview": "두 가족의 만남과 비극적인 결말.",
          "genres": [
            "Drama",
            "Thriller"
          ],
          "year": 2019,
          "rating": 8.6,
          "vote_count": 800000,
          "popularity": 90.5,
          "actors": [
            "송강호",
            "이선균"
          ],
          "directors": [
            "봉준호"
          ]
        }
      },
      {
        "_index": "movies",
        "_id": "5",
        "_score": 0.27779987,
        "_source": {
          "title": "스파이더맨: 노 웨이 홈",
          "overview": "정체가 밝혀진 스파이더맨의 차원 여행.",
          "genres": [
            "Action",
            "Adventure"
          ],
          "year": 2021,
          "rating": 8.3,
          "vote_count": 1700000,
          "popularity": 97.8,
          "actors": [
            "톰 홀랜드",
            "젠데이아"
          ],
          "directors": [
            "존 왓츠"
          ]
        }
      }
    ]
  }
}
```

---

## ❓ 의문점

어째서 “꿈의 세계”를 검색했는데 위와 같은 응답을 받았는지 이해가 안 된다. 한번 분석해보자.

### 1) 먼저 “정말 용어가 겹쳤는지”부터 확인

#### (a) 쿼리 텍스트 분석

```json
POST /movies/_analyze
{
  "analyzer": "kr_text",      // 매핑에 쓴 analyzer와 동일해야 함
  "text": "꿈의 세계"
}
```

→ 기대 토큰: `["꿈","세계"]` (의 는 제거)

> ⚠️ 여기서 “의”가 제거되어야 한다는데, 응답 결과에 “의”가 포함되어 있다. 결국 이 “의”가 포함된 title/overview가 모두 나온 것 같다. 자세히 보면 모두 “의”가 들어가 있고, score가 가장 높은 인셉션의 경우에는 “꿈”까지 포함하고 있다.
>
> 이 외에 더 확인사항이 있었지만 skip하자. 이게 원인인 것 같다.

------

`kr_text`(Nori)로 분석했을 때 **조사 ‘의’가 토큰으로 남는** 게 원인입니다. 이러면 `multi_match`가 `꿈`, `의`, `세계` 3개 토큰 중 **아무거나 1개만** 매칭돼도 hit가 될 수 있어요(기본 `operator: OR`). 그래서 인셉션 외 문서에도 낮은 점수로 매칭이 생깁니다.

아래 2가지 방향 중 하나(또는 둘 다)를 적용하면 깔끔히 해결됩니다.

1. 재색인 → [Elasticsearch 재색인 방법](추가%20학습/Elasticsearch%20재색인%20방법.md)

2. 쿼리 제어 → 재색인 작업이 번거로울 경우 임시 방편이다.

   ```json
   GET /movies/_search
   {
     "query": {
       "multi_match": {
         "query": "꿈의 세계",
         "fields": ["title^3","overview"],
         "analyzer": "kr_text",           // 가능하면 kr_search 같은 불용어 제거 분석기를 지정
         "operator": "AND",               // 모든 토큰 필요
         "minimum_should_match": "2"      // 최소 2개 이상 매칭(‘의’ 하나만 맞아도 통과 못함)
       }
     }
   }
   ```

# ⚙️ C. Term-level & Range Query

```json
GET /movies/_search
{
  "query": {
    "range": {
      "year": { "gte": 2015 }
    }
  },
  "sort": [{ "rating": "desc" }]
}
```

→ 2015년 이후 개봉작 중 평점 높은 순 정렬.

```json
{
  "took": 8,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 3,
      "relation": "eq"
    },
    "max_score": null,
    "hits": [
      {
        "_index": "movies",
        "_id": "3",
        "_score": null,
        "_source": {
          "title": "기생충",
          "overview": "두 가족의 만남과 비극적인 결말.",
          "genres": [
            "Drama",
            "Thriller"
          ],
          "year": 2019,
          "rating": 8.6,
          "vote_count": 800000,
          "popularity": 90.5,
          "actors": [
            "송강호",
            "이선균"
          ],
          "directors": [
            "봉준호"
          ]
        },
        "sort": [
          8.6
        ]
      },
      {
        "_index": "movies",
        "_id": "1",
        "_score": null,
        "_source": {
          "title": "어벤져스: 엔드게임",
          "overview": "사라진 모두를 되찾기 위한 마지막 전쟁.",
          "genres": [
            "Action",
            "Adventure",
            "Sci-Fi"
          ],
          "year": 2019,
          "rating": 8.4,
          "vote_count": 2500000,
          "popularity": 98.7,
          "actors": [
            "로버트 다우니 주니어",
            "크리스 에반스"
          ],
          "directors": [
            "안소니 루소",
            "조 루소"
          ]
        },
        "sort": [
          8.4
        ]
      },
      {
        "_index": "movies",
        "_id": "5",
        "_score": null,
        "_source": {
          "title": "스파이더맨: 노 웨이 홈",
          "overview": "정체가 밝혀진 스파이더맨의 차원 여행.",
          "genres": [
            "Action",
            "Adventure"
          ],
          "year": 2021,
          "rating": 8.3,
          "vote_count": 1700000,
          "popularity": 97.8,
          "actors": [
            "톰 홀랜드",
            "젠데이아"
          ],
          "directors": [
            "존 왓츠"
          ]
        },
        "sort": [
          8.3
        ]
      }
    ]
  }
}
```

# 📊 D. Aggregation 실습

```json
GET /movies/_search
{
  "size": 0,
  "aggs": {
    "by_genre": {
      "terms": { "field": "genres" },
      "aggs": {
        "avg_rating": { "avg": { "field": "rating" } }
      }
    }
  }
}
```

→ 장르별 평균 평점을 계산.

→ `Kibana`에서 시각화하면 **“장르별 인기 순위”** 차트 생성 가능.

```json
{
  "took": 17,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 5,
      "relation": "eq"
    },
    "max_score": null,
    "hits": []
  },
  "aggregations": {
    "by_genre": {
      "doc_count_error_upper_bound": 0,
      "sum_other_doc_count": 0,
      "buckets": [
        {
          "key": "Action",
          "doc_count": 3,
          "avg_rating": {
            "value": 8.5
          }
        },
        {
          "key": "Adventure",
          "doc_count": 3,
          "avg_rating": {
            "value": 8.466666539510092
          }
        },
        {
          "key": "Sci-Fi",
          "doc_count": 3,
          "avg_rating": {
            "value": 8.633333206176758
          }
        },
        {
          "key": "Drama",
          "doc_count": 2,
          "avg_rating": {
            "value": 8.650000095367432
          }
        },
        {
          "key": "Thriller",
          "doc_count": 2,
          "avg_rating": {
            "value": 8.700000286102295
          }
        }
      ]
    }
  }
}
```

# ✨ E. Highlight 실습

```json
GET /movies/_search
{
  "query": {
    "match": { "overview": "가족" }
  },
  "highlight": {
    "fields": { "overview": {} },
    "pre_tags": ["<mark>"], "post_tags": ["</mark>"]
  }
}
```

→ 줄거리 중 “가족” 관련 문장에 `<mark>` 태그로 강조 표시.

```json
{
  "took": 40,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 1,
      "relation": "eq"
    },
    "max_score": 1.3386735,
    "hits": [
      {
        "_index": "movies",
        "_id": "3",
        "_score": 1.3386735,
        "_source": {
          "title": "기생충",
          "overview": "두 가족의 만남과 비극적인 결말.",
          "genres": [
            "Drama",
            "Thriller"
          ],
          "year": 2019,
          "rating": 8.6,
          "vote_count": 800000,
          "popularity": 90.5,
          "actors": [
            "송강호",
            "이선균"
          ],
          "directors": [
            "봉준호"
          ]
        },
        "highlight": {
          "overview": [
            "두 <mark>가족</mark>의 만남과 비극적인 결말."
          ]
        }
      }
    ]
  }
}
```

# 🔍 F. Fuzzy 검색

```json
GET /movies/_search
{
  "query": {
    "fuzzy": {
      "title": {
        "value": "어벤저쓰",
        "fuzziness": "2"
      }
    }
  }
}
```

→ 오타 “어벤저쓰”로도 “어벤져스: 엔드게임”을 찾아냄.

> “fuzziness”: “AUTO”로는 결과가 나오지 않아서 “2”로 적용

```json
{
  "took": 4,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 1,
      "relation": "eq"
    },
    "max_score": 0.62883455,
    "hits": [
      {
        "_index": "movies",
        "_id": "1",
        "_score": 0.62883455,
        "_source": {
          "title": "어벤져스: 엔드게임",
          "overview": "사라진 모두를 되찾기 위한 마지막 전쟁.",
          "genres": [
            "Action",
            "Adventure",
            "Sci-Fi"
          ],
          "year": 2019,
          "rating": 8.4,
          "vote_count": 2500000,
          "popularity": 98.7,
          "actors": [
            "로버트 다우니 주니어",
            "크리스 에반스"
          ],
          "directors": [
            "안소니 루소",
            "조 루소"
          ]
        }
      }
    ]
  }
}
```

# 🔗 G. Similarity 검색 (More Like This)

```json
GET /movies/_search
{
  "query": {
    "more_like_this": {
      "fields": ["overview"],
      "like": "우주 탐사",
      "min_term_freq": 1,
      "max_query_terms": 12
    }
  }
}
```

→ “우주 탐사”라는 문장과 유사한 줄거리 영화 추천 (예: “인터스텔라”).

아래 응답은 의도한 결과가 아니다 (실패 ❌)

```json
{
  "took": 2,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 0,
      "relation": "eq"
    },
    "max_score": null,
    "hits": []
  }
}
```

---

## 🚨 트러블슈팅

아래는 chatGPT의 답변인데, 아무래도 데이터 규모 자체가 너무 작아서 그런 것으로 추측된다. (첫 번째 답변)

- `min_doc_freq` 기본값이 **5**라서, “우주/탐사” 같은 토큰이 **5개 이상의 문서**에 나오지 않으면 제외됩니다. 지금 인덱스는 소규모라 해당 토큰들이 조건을 못 채워요.
- (덜 흔한 이슈) `more_like_this`가 사용할 **분석기**를 명시하지 않아, 의도한 `kr_text(nori)`가 안 쓰였을 수도 있어요.
- 입력 텍스트 “우주 탐사”가 분석되어 만들어진 토큰이 실제 문서의 토큰과 **다르게 쪼개졌을** 수도 있습니다.

우선 다음과 같은 시도를 해본다.

### 빠른 해결(권장 쿼리)

아래처럼 임계값을 낮추고 분석기를 지정하세요.

```json
GET /movies/_search
{
  "query": {
    "more_like_this": {
      "fields": ["overview"],
      "like": "우주 탐사",
      "min_term_freq": 1,          // 문서 내 최소 등장 빈도
      "min_doc_freq": 1,           // 인덱스 내 최소 문서 수
      "max_query_terms": 50,       // 후보 토큰 넉넉히
      "minimum_should_match": "1", // 최소 일치 기준 완화
      "analyzer": "kr_text"        // nori 커스텀 분석기 강제
    }
  }
}
```

이렇게 요청하니 정상적으로 나왔다.

```json
{
  "took": 6,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 1,
      "relation": "eq"
    },
    "max_score": 2.928872,
    "hits": [
      {
        "_index": "movies",
        "_id": "4",
        "_score": 2.928872,
        "_source": {
          "title": "인터스텔라",
          "overview": "인류의 생존을 건 우주 탐사.",
          "genres": [
            "Adventure",
            "Drama",
            "Sci-Fi"
          ],
          "year": 2014,
          "rating": 8.7,
          "vote_count": 1900000,
          "popularity": 95.2,
          "actors": [
            "매튜 매커너히",
            "앤 해서웨이"
          ],
          "directors": [
            "크리스토퍼 놀란"
          ]
        }
      }
    ]
  }
}
```

개선된 요청에서 몇 가지 옵션을 더 빼봤다.

```json
GET /movies/_search
{
  "query": {
    "more_like_this": {
      "fields": ["overview"],
      "like": "우주 탐사",
      "min_term_freq": 1,          // 문서 내 최소 등장 빈도
      "min_doc_freq": 1            // 인덱스 내 최소 문서 수
    }
  }
}
```

이렇게만 요청해도 응답이 되는 것으로 보아, 역시 첫 번째 원인이 맞았던 것 같다. (위 옵션은 2개 모두 필요하다)

```json
{
  "took": 5,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 1,
      "relation": "eq"
    },
    "max_score": 2.928872,
    "hits": [
      {
        "_index": "movies",
        "_id": "4",
        "_score": 2.928872,
        "_source": {
          "title": "인터스텔라",
          "overview": "인류의 생존을 건 우주 탐사.",
          "genres": [
            "Adventure",
            "Drama",
            "Sci-Fi"
          ],
          "year": 2014,
          "rating": 8.7,
          "vote_count": 1900000,
          "popularity": 95.2,
          "actors": [
            "매튜 매커너히",
            "앤 해서웨이"
          ],
          "directors": [
            "크리스토퍼 놀란"
          ]
        }
      }
    ]
  }
}
```

---



## 🧪 H. 실습 확장 아이디어

| 주제                 | 설명                                     |
| -------------------- | ---------------------------------------- |
| `bool + aggregation` | “2015년 이후 개봉작 중 장르별 평균 평점” |
| `highlight + fuzzy`  | “오타 검색 결과 하이라이팅”              |
| `range + sort`       | “연도별, 평점별 트렌드 정렬”             |
| `more_like_this`     | “비슷한 주제의 영화 추천 기능”           |
