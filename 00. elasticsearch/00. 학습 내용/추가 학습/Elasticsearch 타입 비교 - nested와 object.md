# Elasticsearch 타입 비교 - nested와 object

> 아래는 Gemini에게 얻은 답변이다.

---

Elasticsearch에서 **`nested`** 타입과 **`object`** 타입의 가장 큰 차이점은 **배열 내 객체들의 관계를 보존하는지 여부**입니다.

## 1. Object 타입 (기본 동작)

`object` 타입은 JSON 객체 구조를 나타내며, 중첩된 객체가 포함된 배열을 색인할 때 **내부 필드들의 연관 관계가 사라지는 문제(Flattening)**가 발생합니다.

### 주요 특징 및 문제점

- **구조 평면화 (Flattening):** 배열 내의 객체들을 색인할 때, 내부 필드들은 상위 객체 이름과 결합되어 **단일 필드 목록으로 평면화**됩니다.
  - 예: `{ "colors": [ { "name": "red", "hex": "#FF0000" }, { "name": "blue", "hex": "#0000FF" } ] }`
  - 색인 시: `colors.name: ["red", "blue"]`, `colors.hex: ["#FF0000", "#0000FF"]`
- **관계 손실:** `colors.name`의 `"red"`와 `colors.hex`의 `"#FF0000"`이 원래 한 객체였던 관계가 끊어집니다.
- **잘못된 검색 결과 가능성:** 이로 인해 'name이 "red"이고 hex가 "#0000FF"인' 객체를 검색하면 (원래 문서에는 없더라도) 해당 문서가 검색될 수 있습니다. (예: `colors.name`에 `"red"`가 있고, `colors.hex`에 `"#0000FF"`가 있기 때문에).
- **용례:**
  - **단일 중첩 객체:** 배열이 아닌, 단순한 중첩 객체를 저장할 때 (예: `user: { first: "John", last: "Doe" }`).
  - **관계 보존이 불필요한 객체 배열:** 객체 배열이지만, 배열 요소 내의 필드 간 관계를 유지하며 검색할 필요가 없을 때.

## 2. Nested 타입 (객체 관계 보존)

`nested` 타입은 `object` 타입의 **관계 손실 문제**를 해결하기 위해 설계되었으며, 배열 내 각 객체를 **개별적인 숨겨진 Lucene 문서**로 색인합니다.

### 주요 특징 및 고려 사항

- **관계 보존:** 배열 내 각 객체의 필드들을 하나의 단위로 유지하여, 객체 내부 필드 간의 정확한 연관 관계를 보존합니다.
  - 위의 `colors` 예시에서, `"red"`는 항상 `"#FF0000"`과 연결되고 `"blue"`는 `"#0000FF"`와 연결됩니다.
- **개별 문서로 색인:** 원본 문서와는 별도로, 배열 내 각 객체는 **숨겨진 독립적인 Lucene 문서**로 저장됩니다.
- **특수 쿼리 사용:** `nested` 필드를 검색하거나 집계할 때는 **반드시** `nested query`나 `nested aggregation`을 사용해야 합니다. 일반 `match query` 등으로는 정확한 검색이 불가능합니다.
- **성능/비용:** 추가적인 내부 문서 생성 및 조인(Join) 작업 때문에 일반 `object` 타입에 비해 **색인 및 검색 성능 비용(오버헤드)**이 더 발생합니다.
- **용례:**
  - **객체 배열의 필드 간 관계가 중요할 때:** 문서 배열 내에서 특정 필드 조합으로만 정확하게 검색해야 할 때.
  - 예: 쇼핑몰 상품 문서에 `attributes` 배열이 있고, '크기가 "L"이면서 색상이 "파랑"인' 속성을 가진 상품을 정확히 찾고자 할 때.

## 요약 비교

| **특징**      | **object 타입**                         | **nested 타입**                             |
| ------------- | --------------------------------------- | ------------------------------------------- |
| **기본 동작** | JSON 객체 (기본)                        | 객체 배열의 관계 보존                       |
| **배열 처리** | 필드 평면화 (Flattening)                | 각 객체를 독립적인 숨겨진 문서로 색인       |
| **필드 관계** | **손실됨** (잘못된 결과 가능성)         | **보존됨** (정확한 결과 보장)               |
| **검색 방법** | 일반 쿼리 사용 가능                     | **반드시 `nested query` 사용**              |
| **성능/비용** | 빠름/낮음 (기본)                        | 느림/높음 (오버헤드 발생)                   |
| **주요 용례** | 단순 중첩 객체, 관계 불필요한 객체 배열 | 객체 배열 내의 필드 관계 보존이 필수적일 때 |